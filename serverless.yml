# Read the documentation at https://www.serverless.com/framework/docs/providers/aws/guide/serverless.yml/
service: symfony

provider:
  name: aws
  # The AWS region in which to deploy (us-east-1 is the default)
  region: us-east-1
  # The stage of the application, e.g. dev, production, stagingâ€¦ ('dev' is the default)
  stage: prod
  runtime: provided.al2
  environment:
    # Symfony environment variables
    APP_ENV: prod

plugins:
  - ./vendor/bref/bref

functions:
  # This function runs the Symfony website/API
  web:
    handler: public/index.php
    timeout: 28 # in seconds (API Gateway has a timeout of 29 seconds)
    layers:
      - ${bref:layer.php-74-fpm}
    events:
      - httpApi: "*"
    vpc:
      securityGroupIds:
        - sg-eb16dbf2
      subnetIds:
        - subnet-dc0a46fd
        - subnet-e78ecdb8
        - subnet-24f6e069
        - subnet-30fdc53e
        - subnet-b32ea482
        - subnet-f4733592
  # This function let us run console commands in Lambda
  console:
    handler: bin/console
    timeout: 120 # in seconds
    layers:
      - ${bref:layer.php-74} # PHP
      - ${bref:layer.console} # The "console" layer
    vpc:
      securityGroupIds:
        - sg-eb16dbf2
      subnetIds:
        - subnet-dc0a46fd
        - subnet-e78ecdb8
        - subnet-24f6e069
        - subnet-30fdc53e
        - subnet-b32ea482
        - subnet-f4733592
package:
  patterns:
    # Excluded files and folders for deployment
    - "!assets/**"
    - "!public/build/**"
    - "!public/bundles/**"
    - "public/build/manifest.json"
    - "public/build/entrypoint.json"
    #- '!assets/**'
    #- '!node_modules/**'
    #- '!public/build/**'
    #- '!tests/**'
    #- '!var/**'
    # If you want to include files and folders that are part of excluded folders,
    # add them at the end
    - "var/cache/prod/**"
    #- 'public/build/entrypoints.json'
    #- 'public/build/manifest.json'

resources:
  Resources:
    # The S3 bucket that stores the assets
    Assets:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: houssem-symfony-prod-assets
    # The policy that makes the bucket publicly readable
    AssetsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref Assets # References the bucket we defined above
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: "*" # everyone
              Action: "s3:GetObject" # to read
              Resource: !Join ["/", [!GetAtt Assets.Arn, "*"]] # things in the bucket
              # alternatively you can write out Resource: 'arn:aws:s3:::<bucket-name>/*'
